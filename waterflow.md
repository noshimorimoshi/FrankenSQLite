## Домен: Закупки

Этот документ определяет схему данных для процесса закупки товаров, от каталогизации до заказа.

---

## Справочные таблицы

Эти таблицы содержат предопределенные или часто используемые значения.

### Таблица: `status`
| id | name | description | type |
|---|---|---|---|
| 1 | Оформление заказа | | order |
| 2 | Заказан (не оплачен) | покупатель оформил заказ, но не оплатил. | order |
| 3 | Оплачен | продавец получил деньги, готовит товар. | order |
| 4 | Отменён (до отправки) | заказ аннулирован до отправки. | order |
| 5 | Приобретён где-то ещё | покупатель нашёл аналогичный товар в другом месте. | order |
| 6 | Решено не заказывать | покупатель отказался от покупки. | order |
| 7 | Ошибочно заказан (до отправки) | товар не соответствует ожиданиям (не тот размер, цвет и т. д.). | order |
| 8 | Тестовый заказ (оформлен) | заказан образец для проверки перед массовой закупкой. | order |
| 9 | Отложен (оформление) | заказ временно не оформляется, решение будет принято позже. | order |
| 10 | Подготовка и отправка | | shipment |
| 11 | Упакован | товар подготовлен к отправке. | shipment |
| 12 | Отправлен | передан транспортной компании. | shipment |
| 13 | Изменён адрес доставки | получатель запросил изменение адреса. | shipment |
| 14 | Транспортировка | | shipment |
| 15 | В пути | движется к стране назначения. | shipment |
| 16 | Прибыл в страну | достиг границы страны получателя. | shipment |
| 17 | На таможне | проходит проверку. | shipment |
| 18 | Растаможен | допущен к доставке. | shipment |
| 19 | Локальная доставка | | shipment |
| 20 | На доставке | передан местному перевозчику. | shipment |
| 21 | В пункте выдачи | ожидает получения. | shipment |
| 22 | Неудачная попытка доставки | курьер не смог доставить. | shipment |
| 23 | Получен | покупатель подтвердил получение. | order |
| 24 | Неполучен | покупатель не получил посылку. | order |
| 25 | Частично получен (из нескольких заказов) | часть комплектующих пришла, часть ещё в пути. | order |
| 26 | Частично утерян (из нескольких заказов) | часть заказов утеряна. | order |
| 27 | Частично не заказан (из нескольких заказов) | какие-то части товара ещё не были оформлены. | order |
| 28 | Утерян | посылка пропала по дороге. | order |
| 29 | Повреждён | товар повреждён в процессе доставки. | order |
| 30 | Ошибочно заказан (финальный) | заказан неверный товар (не тот размер, цвет, модель и т. д.), дальнейшие действия не определены. | order |
| 31 | Тестовый заказ одобрен | образец устроил, можно заказывать партию. | order |
| 32 | Тестовый заказ не одобрен | образец не устроил, массовый заказ не будет оформлен. | order |
| 33 | Возврат и споры | | return_dispute |
| 34 | Открыт спор | покупатель подал претензию. | return_dispute |
| 35 | Спор: Ожидание решения | продавец/платформа рассматривает спор. | return_dispute |
| 36 | Возвращён | покупатель отправил товар обратно. | return_dispute |
| 37 | Возврат подтверждён | продавец получил возврат. | return_dispute |
| 38 | Возврат средств | деньги возвращены покупателю. | return_dispute |
| 39 | Активен в очереди | Элемент находится в активной очереди для рассмотрения или обработки. | queue |
| 40 | На паузе в очереди | Элемент временно приостановлен в обработке. | queue |
| 41 | Отменён (продавец) | Элемент удален из очереди по причине отмены продавцом. | queue |
| 42 | Обработка возврата/спора (в очереди) | Элемент связан с текущим процессом возврата или спора. | queue |
| 43 | Завершён (очередь) | Элемент обработан из очереди (например, добавлен в корзину, архивирован). | queue |
| 44 | Отложен (в очереди) | Элемент временно не обрабатывается в очереди, решение будет принято позже. | queue |
| 45 | Решено не заказывать (в очереди) | Принято решение не заказывать товар из очереди. | queue |
| 46 | New | Новая задача в конвейере. | pipeline |
| 47 | Cataloging | Идет процесс каталогизации. | pipeline |
| 48 | Pricing | Идет процесс сбора цен. | pipeline |
| 49 | Qualification | Квалификация товара для участия в акциях. | pipeline |
| 50 | In Basket | Добавлен в корзину. | pipeline |
| 51 | Ordered | Заказан. | pipeline |
| 52 | Qualified | Квалификация пройдена, ожидает дальнейших действий. | pipeline |
| 53 | No Action | Не подходит ни под одну акцию. | pipeline |

### Таблица: `breadcrumb`
| id | parent_id | name |
|---|---|---|
| 1 | NULL | AliExpress |
| 2 | 1 | Обустройство дома и инструменты|
| 3 | 2 | Ремонт и обустройство |
| 4 | 3 | Крепеж и скобяные изделия |
| 5 | 4 | Пневматические детали |
| 6 | 1 | Дом, сад и офис |
| 7 | 6 | Лампы и освещение |
| 8 | 7 | Светодиодное освещение |
| 9 | 8 | Светодиодная лента |
| 10 | 3 | Электрика |
| 11 | 10 | Кабели и провода |
| 12 | 11 | Электрические провода |
| 13 | 10 | Разъемы и клеммы |
| 14 | 13 | Разъемы |
| 15 | 6 | Кухня, столовая и бар |
| 16 | 15 | Кухонные инструменты и приборы |
| 17 | 16 | Чеснокочистка |
| 18 | NULL | Avito |
| 19 | 18 | Для дома и дачи |
| 20 | 19 | Товары для кухни |
| 21 | 20 | Приготовление пищи |
| 22 | 21 | Принадлежности для готовки |
| 23 | NULL | Auchan |
| 24 | 23 | Кухня |
| 25 | 24 | Кухонные принадлежности |
| 26 | 25 | Терки, овощерезки, прессы |

### Таблица: `currency`
*(Шаблон таблицы без данных)*
| id | code | name |
|---|---|---|

### Таблица: `warehouse`
*(Шаблон таблицы без данных)*
| id | name |
|---|---|

---

## ЧТО КУПИТЬ (Товар и его цена)

### Таблица: `product`
| id | keyword | wekan_task_id | created_at | updated_at | wekan_priority |
|---|---|---|---|---|---|
| 15 | разъём rj9 / rj10 / rj11; male plug connector; 4P4 plug RJ9/RJ10 | | 2024-04-13 22:00:00 | 2024-04-13 22:00:00 | 3 |
| 76 | Аудио кабель 4-полюсный разъем стерео | | 2024-04-13 22:00:00 | 2024-04-13 22:00:00 | 0 |
| 52 | Клей Момент | | 2024-08-16 10:00:00 | 2024-08-16 10:00:00 | 2 |
| 4 | Пневматическая быстроразъёмная муфта PCF 6-04 | | 2021-03-20 00:00:00 | 2021-03-20 00:00:00 | 6 |
| 2 | RGB светодиодная лента HugSunLight | | 2024-07-21 00:00:00 | 2024-07-21 00:00:00 | 6 |
| 20 | Ручной пресс для чеснока | | 2024-10-10 00:00:00 | 2024-10-10 00:00:00 | 3 |
| 6 | Медный провод 0,1, ~ длина 650 м -400 ПРОМОКОД COMBO | | 2024-09-09 00:00:00 | 2024-09-09 00:00:00 | 5 |
| 75 | Трусы | | 2025-03-07 00:00:00 | 2025-03-07 00:00:00 | 1 |
| 77 | UBRR MyLife+ v01.08.25 (Подписка) | | 2025-08-01 00:00:00 | 2025-08-01 00:00:00 | 0 |

### Таблица: `catalog`
| id | product_id (FK) | name | url | model | cost | seller_discount | shipping_cost | brand | description | barcode | vendor_code |
|---|---|---|---|---|---|---|---|---|---|---|---|
| 1 | 4 | Белые пневматические фитинги 1/4 1/2 6 мм 8 мм BSP | aliexpress.ru/item/1005004135633297.html | Цвет 6-04 (6mm-1/2) Характеристики PCF | 275 | 115 | 0 | | Пневматическая быстроразъёмная муфта PCF 6-04 для трубопровода трахея (trachea) | | |
| 2 | 2 | RGB светодиодная лента HugSunLight 5 м | aliexpress.ru/item/32780331531.html | Длина 3m Испускаемый цвет Cold White Led Strip | 275 | | | HugSunLight | RGB светодиодная лента HugSunLight | | |
| 3 | 6 | Медный провод 0,1~1,5 мм 50 г | aliexpress.ru/item/1005006345160960.html | Цвет:0.1mm-650m Длина:1Roll | 245 | | | NULL | Характеристики: Магнитная проволока, ... | NULL | NULL |
| 4 | 15 | Разъемы RJ9 RJ11 RJ45 TLZWLA | aliexpress.ru/item/1005007947349145.html | Номер модели: RJ11, Цвет: 4P4C, Количество: 10 штук в упаковке | 46 | | | TLZWLA | Происхождение: Китай; ... | NULL | NULL |
| 5 | 6 | Медный провод 0,1~1,5 мм 50 г | aliexpress.ru/item/1005006345160960.html | Цвет:0.1mm-650m Длина:3Rolls | 624 | | | NULL | Характеристики: Магнитная проволока, ... | NULL | NULL |
| 6 | 20 | Многофункциональный ручной пресс для чеснока... | aliexpress.ru/item/1005006973938089.html | Черный | 333 | | | HARKO | Многофункциональный ручной чесночный пресс... | | |
| 7 | 20 | Пресс для чеснока «Мультидом» Виват | auchan.ru/product/press-dlya-chesnoka-vivat/ | NULL | 409.99| 0 | 0 | Мультидом | Пресс для чеснока «Мультидом» Виват | | |

### Таблица: `catalog_breadcrumb`
| catalog_id (FK) | breadcrumb_id (FK) | breadcrumb_type |
|---|---|---|
| 1 | 5 | marketplace |
| 2 | 9 | marketplace |
| 3 | 12 | marketplace |
| 4 | 14 | marketplace |
| 5 | 12 | marketplace |
| 6 | 17 | marketplace |
| 7 | 26 | marketplace |
| 8 | 22 | marketplace |

### Таблица: `media`
| id | catalog_id (FK) | type    | url                             | alt_text                      | sort_order |
|----|-----------------|---------|---------------------------------|-------------------------------|------------|
| 1  | 3               | image   | S6c7d20b23a7a4d579a1bd3c951d19686p.webp | Изображение медного провода   | 1          |
| 2  | 3               | image   | S503fc7bc91434255b065731c2badb628p.webp | Изображение медного провода   | 2          |
| 3  | 3               | image   | S8610f667ae164e5bb883df677790de3eR.webp | Изображение медного провода   | 3          |
| 4  | 3               | image   | S212909f7d7f54872b88339c857926448n.jpg_640x640.webp | Изображение медного провода   | 4          |
| 5  | 3               | image   | Sae810d10680c45d5b0d1ee3596535b11X.webp | Изображение медного провода   | 5          |
| 6  | 3               | image   | Sb590f4cbd6854cae920598ab45b73db5j.webp | Изображение медного провода   | 6          |
| 7  | 3               | image   | Sc2f0d6672b604b92bd9730670a422b5fC.webp | Изображение медного провода   | 7          |
| 8  | 3               | image   | Sfa6d3ef591194ff6a1c9e6a22856ef37v.webp | Изображение медного провода   | 8          |
| 9  | 1               | image   | S6325826ff71e4001a160ce48c1bdc060y.webp | Изображение пневматического фитинга | 1          |
| 10 | 1               | image   | Sb9bc2e198eb34ca6b41a4527c2512bf9T.webp | Изображение пневматического фитинга | 2          |
| 11 | 1               | image   | Sc1ca0bd1d19e45e1b085eab6e5212afd4.webp | Изображение пневматического фитинга | 3          |
| 12 | 1               | image   | S4b987b72fccf49269c6279869ab60655p.webp | Изображение пневматического фитинга | 4          |
| 13 | 2               | image   | HTB1NL60OFXXXXc2XVXXq6xXFXXXP.webp | Изображение светодиодной ленты | 1          |
| 14 | 2               | image   | HTB17_fiV6TpK1RjSZKPq6y3UpXa8.webp | Изображение светодиодной ленты | 2          |
| 15 | 2               | image   | S380b35f6167e416ab569c2ac841abe45A.webp | Изображение светодиодной ленты | 3          |
| 16 | 2               | image   | S1dc3765309a142e4b3344b5defd2850ca.webp | Изображение светодиодной ленты | 4          |
| 17 | 2               | image   | Sd0ee11c32c034c1aa0fc6bee0ac58d77U.webp | Изображение светодиодной ленты | 5          |
| 18 | 2               | image   | Sc7e85f8d2d124a7796522a561b1d418eO.webp | Изображение светодиодной ленты | 6          |
| 19 | 2               | video   | TB2kvXpbL5TBuNjSspcXXbnGFXa_!!6000000002414-0-tbvideo.jpg | Видео светодиодной ленты      | 7          |
| 20 | 2               | image   | H6292a518ca304920bf55d4467e496e56k.jpg_640x640.webp | Изображение светодиодной ленты | 8          |
| 21 | 4               | image   | S2a7b73ed14404230b3c9af211ec51fb8T.webp | Изображение разъемов RJ | 1          |
| 22 | 4               | image   | Sbe344a55a2a442cab2c2862ec8e114afX.webp | Изображение разъемов RJ | 2          |
| 23 | 4               | image   | S3e07495c2de149868b3523834e4d52a6v.webp | Изображение разъемов RJ | 3          |
| 24 | 4               | image   | Scfe60bf36c7541d3851374d4249fcc8eX.webp | Изображение разъемов RJ | 4          |
| 25 | 4               | image   | S07ec05a1ed514e1caf76c70a010001663.webp | Изображение разъемов RJ | 5          |
| 26 | 4               | image   | Sf9cb07df066e45629b992ae3c36a4639Z.webp | Изображение разъемов RJ | 6          |
| 27 | 4               | image   | Sc25a7907159742c7a6e4c08af099c4c01.jpg_640x640.webp | Изображение разъемов RJ | 7          |
| 28 | 6               | image   | S768adde9f71b4fe9b4b857cbd33762d6I.webp | Изображение пресса для чеснока | 1          |
| 29 | 6               | image   | Sd66d2cfe08044dd4bf6147c78786f398T.webp | Изображение пресса для чеснока | 2          |
| 30 | 6               | image   | Scfeef2c06675434e864afc3b3806c193x.webp | Изображение пресса для чеснока | 3          |
| 31 | 6               | image   | Sfdb684536dfe4544b8b0f1e745110858R.webp | Изображение пресса для чеснока | 4          |
| 32 | 6               | image   | S2c11c39183a14af181c8f22eded53e09g.webp | Изображение пресса для чеснока | 5          |
| 33 | 6               | image   | Sfb05b032bfbe425b87c13e602dc624cep.webp | Изображение пресса для чеснока | 6          |

### Таблица: `product_inventory`
*(Шаблон таблицы без данных)*
| id | catalog_id (FK) | warehouse_id (FK) | stock_qty | reserved_qty | location |
|---|---|---|---|---|---|

### Таблица: `promotion`
| id | name | promotion_type | discount_type | discount_value | conditions | coupon_code | marketplace | start_date | end_date | 
|---|---|---|---|---|---|---|---|---|---|
| 1 | 500₽ от 5000₽ для новичков из РФ на товары "Нихао" | coupon | fixed | 500 | для новичков из РФ на товары "Нихао" от 5000₽ | НИХАО | AliExpress | | 2025-08-28 | 
| 2 | до 450₽ от 4500₽ в магазине спортивной обуви Li-ning | coupon | fixed | 450 | от 4500₽ в магазине Li-ning | LNAUG5 | AliExpress | | 2025-08-28 | 
| 3 | до 800₽ от 8000₽ в магазине Dreame | coupon | fixed | 800 | от 8000₽ в магазине Dreame | DREAME25828 | AliExpress | | 2025-08-28 | 

### Таблица: `product_promotion`
| product_id | promotion_id | ?relevance_score? |
|---|---|---|
| 4 | 1 | 1.0 |

### Таблица: `offer`
*(Шаблон таблицы без данных)*
| id | catalog_id (FK) | channel | price | status_id (FK) | available | acquisition_cost |
|---|---|---|---|---|---|---|

---

## КАК (Процесс приобретения)

### Таблица: `basket`
*(Шаблон таблицы без данных)*
| id | user_account_id (FK) | created_at | updated_at | total_amount | strategy | basket_type |
|---|---|---|---|---|---|---|

### Таблица: `basket_item`
*(Шаблон таблицы без данных)*
| id | basket_id (FK) | catalog_id (FK) | qty | added_at | price_at_add | subtotal |
|---|---|---|---|---|---|---|

### Таблица: `order`
*(Шаблон таблицы без данных)*
| id | user_account_id (FK) | order_date | status_id (FK) | total_amount | shipping_address_id (FK) | billing_address_id (FK) |
|---|---|---|---|---|---|---|

### Таблица: `order_item`
*(Шаблон таблицы без данных)*
| id | order_id (FK) | catalog_id (FK) | qty | price_per_item | subtotal |
|---|---|---|---|---|---|

### Таблица: `shipment`
*(Шаблон таблицы без данных)*
| id | order_id (FK) | shipped_at | delivered_at | tracking_number | status_id (FK) | shipping_cost | shipping_address_id (FK) |
|---|---|---|---|---|---|---|

---

## НА ЧТО (Финансовые инструменты)

### Таблица: `wallet`
*(Шаблон таблицы без данных)*
| id | name | balance | currency_id (FK) |
|---|---|---|---|

### Таблица: `pay_method`
*(Шаблон таблицы без данных)*
| id | name | wallet_id (FK) | currency_id (FK) | details |
|---|---|---|---|---|

### Таблица: `payment`
*(Шаблон таблицы без данных)*
| id | order_id (FK) | pay_method_id (FK) | paid_at | amount | cashback_received |
|---|---|---|---|---|---|

---

## КТО ПОКУПАЕТ (Пользователь и его аккаунты)

### Таблица: `user_account`
*(Шаблон таблицы без данных)*
| id | username | password | email | created_at | default_shipping_address_id (FK) |
|---|---|---|---|---|---|

### Таблица: `user_subscription`
| id | user_account_id (FK) | cashback_program_id (Logical FK to CASHBACK_SERVICE.cashback_program) | activated_at | expires_at | status |
|---|---|---|---|---|---|
*(Шаблон таблицы без данных)*

### Таблица: `address`
*(Шаблон таблицы без данных)*
| id | street | city | state_province | postal_code | country | building_apt | details |
|---|---|---|---|---|---|---|---|

### Таблица: `web_service`
| id | name | url | is_active | status_id (FK) | created_at |
|---|---|---|---|---|---|
| 1 | Backit | backit.me | true | NULL | 2024-05-13 |
| 2 | УБРиР | ubrr.ru | true | NULL | 2024-05-13 |
| 3 | Ozon Finance | finance.ozon | true | NULL | 2024-05-13 |
| 4 | ВТБ | vtb.ru | true | NULL | 2024-05-13 |
| 5 | Сбер | sber.ru | true | NULL | 2024-05-13 |
| 6 | Альфа-Банк | alfabank.ru | true | NULL | 2024-05-13 |
| 7 | Совкомбанк | sovcombank.ru | true | NULL | 2024-05-13 |
| 8 | Газпромбанк | gpb.ru | true | NULL | 2024-05-13 |

### Таблица: `box`
*(Шаблон таблицы без данных)*
| id | user_account_id (FK) | name | address_id (FK) |
|---|---|---|---|

### Таблица: `login`
*(Шаблон таблицы без данных)*
| id | username | password | box_id (FK) | web_service_id (FK) |
|---|---|---|---|---|
---

## Внешние процессы

**Примечание:** Управление рабочим процессом и отслеживание истории изменений статусов осуществляются через внешние системы, описанные в следующих файлах:
- **`PIPELINE.md`**: Определяет текущий статус и приоритет задач в обработке.
- **`tracker.md`**: Логирует все переходы между статусами для анализа времени выполнения этапов.
- **`CASHBACK_SERVICE.md`**: Определяет доступные кэшбэк-программы и их провайдеров.

---

## Последовательность Заполнения Таблиц (Data Flow)

Этот раздел описывает логическую последовательность создания и обновления записей в таблицах в соответствии с рабочим процессом, описанным в `PIPELINE.md`.

**Этап 0: Инициация (Задача)**
1.  **`product`**: Процесс начинается с создания записи о новом товаре.
2.  **`PIPELINE.md`**: Для нового `product` создается задача со статусом `New`.

**Этап 1: Каталогизация (`Cataloging`)**
3.  **`catalog`**: Находятся и добавляются конкретные предложения товара с разных площадок.
4.  **`breadcrumb` и `catalog_breadcrumb`**: Сохраняется иерархия категорий для каждого `catalog`.
5.  **`media`**: Добавляются изображения и видео.

**Этап 2: Сбор Цен (`Pricing`)**
6.  **`offer`**: Собираются конкретные ценовые предложения.
7.  **`promotion`**: Заносятся все применимые акции и купоны.
8.  **`product_promotion`**: Акции связываются с товарами.
9.  **`CASHBACK_SERVICE.md` (`cashback_program`)**: Анализируются и заносятся доступные кэшбэк-программы. На этом этапе происходит проверка `required_subscription_product_id`.

**Этап 3: Квалификация (`Qualification`)**
10. **`user_subscription`**: При необходимости проверяется наличие активной подписки у пользователя.
11. **`PIPELINE.md` (обновление)**: Статус задачи меняется на `Qualified` или `No Action`.

**Этап 4: Покупка (In Basket -> Ordered)**
12. **`basket` и `basket_item`**: Квалифицированный товар добавляется в корзину.
13. **`order` и `order_item`**: Создается заказ.
14. **`payment`**: Фиксируется оплата.
15. **`shipment`**: Отслеживается доставка.
