### **Рабочее соглашение (версия 7.1) - Совместная работа и Процесс**

**0. Принципы нашего взаимодействия (Как мы работаем вместе):**
*   **Диалог и Гибкость:** Если мы обнаруживаем, что план неоптимален или что-то неясно, мы **останавливаемся, обсуждаем и корректируем курс**. Я (AI ассистент) не вношу изменения в ключевые документы без вашего согласия.
*   **Процесс, управляемый Пайплайном:** Наш рабочий процесс управляется файлом `PIPELINE.md`. Мы берем задачи из него в соответствии с приоритетом и статусом, обрабатываем их и обновляем их состояние, фиксируя историю в `tracker.md`.
*   **Совместная ответственность:** Мы вместе принимаем ключевые решения о схеме (`SCHEMA.md`) и процессе, зафиксированном в этом документе.
*   **`waterflow.md` как "Живой Пример"**: Мы признаем, что `waterflow.md` является рабочим документом для иллюстрации структуры и процесса. Он не обязан содержать исчерпывающие данные для всех таблиц на всех этапах.

**1. Главная миссия:**
*   Итеративно построить и проверить оптимальную схему данных (`SCHEMA.md`) и рабочий процесс для системы отслеживания заказов, используя `waterflow.md` как полигон для проверки наших гипотез.

**2. Наш Текущий Рабочий Процесс (Гибридная Модель):**
*   *Этот раздел описывает наш **текущий** план. Мы можем и должны его пересматривать.*
*   **Этап 1: Индивидуальная обработка.**
    1.  Задачи обрабатываются индивидуально согласно их приоритету в `PIPELINE.md`.
    2.  Они проходят через последовательность статусов (например, 'new' -> 'cataloged' -> 'priced').
    3.  Результатом этого этапа является накопление обработанных товаров в статусе `'staging'` (готовы к группировке).
*   **Этап 2: Стратегическое формирование корзины.**
    1.  На этом этапе мы анализируем **все** товары в статусе `'staging'`.
    2.  Мы применяем стратегии (см. таблицу `basket`) для формирования оптимальных корзин, чтобы максимизировать выгоду от скидок маркетплейсов, купонов и стоимости доставки.

**3. Ключевые Атрибуты и их Роль:**
*   **`product.wekan_priority` vs `pipeline.priority`:** Важно различать эти два поля.
    *   `product.wekan_priority` — это исходный, "сырой" приоритет, полученный из внешней системы. Это статическая, историческая запись.
    *   `pipeline.priority` — это операционный, "живой" приоритет, который используется для сортировки задач в конвейере. В будущем он может вычисляться на основе `wekan_priority` и других факторов, как описано в `priotity_intellect_architect.md`.

**4. Наш новый рабочий цикл:**
*   **1. Выборка Задачи:** Я автоматически определяю задачу для обработки. Для этого я нахожу в `PIPELINE.md` запись с наивысшим `priority` и статусом, готовым к работе (например, 'new' с `status_id=46`).
*   **2. Обработка Задачи:** Мы совместно работаем над выбранной сущностью (например, проверяем и заполняем `catalog` для `product`).
*   **3. Обновление Статуса и Трекинг:** После завершения этапа я обновляю `status_id` и `last_updated_at` для этой задачи в `PIPELINE.md`. Одновременно я добавляю запись о переходе статуса в `tracker.md`. Это действие является нашей основной системой отслеживания времени, позволяя измерять "время цикла" (Cycle Time) для каждого этапа.
*   **4. Повторение:** Мы возвращаемся к шагу 1 для следующей задачи. Мы "проталкиваем" один товар по конвейеру до статуса `'staging'` (`status_id=49`), после чего возвращаемся к следующему по приоритету товару.

**5. Архитектурные гипотезы и отложенные идеи:**
*   **Переход к микросервисной архитектуре:** Зафиксирована долгосрочная цель по раздроблению монолитной базы данных на независимые, переиспользуемые сервисы. Это предполагает выделение таких сущностей как "кто" (`USER_SERVICE.md`) и "на что" (`LEDGER_SERVICE.md`) в отдельные сервисы, с которыми наша основная система будет общаться через API и транзакции. Эта цель влияет на то, как мы проектируем новые функции, подталкивая нас к созданию независимых модулей.
*   **Рейтинговый сервис (`priority_intellect_architect.md`):** Первый кандидат на выделение в микросервис.
*   **Система трекинга времени:** Мы пришли к выводу, что `tracker.md` на данный момент полностью удовлетворяет наши потребности в отслеживании "времени цикла" (Cycle Time). Более сложные гипотезы (ручной трекинг "Lead Time") отложены на неопределенный срок до выявления реальной бизнес-потребности.

----
Пост скриптум: Прежде чем ответить, оцени неопределённость своего ответа. Если она больше 0.1, задай нам уточняющие вопросы, пока она не станет 0.1 или ниже