# Рабочий Процесс Тестового Заказа для Сбора Данных

Этот документ описывает этапы рабочего процесса тестового заказа, следуя которому мы будем извлекать и фиксировать данные в DATA.md. Цель - собрать структурированные данные, необходимые для валидации и корректировки схемы базы данных в SCHEMA.md. Весь процесс направлен на упорядоченное заполнение таблиц базы данных SQLite, созданных на основе SCHEMA.md, данными, соответствующими тестовому рабочему процессу.

## 1. Приоритезация (Бэклог/Выбор Товаров)

На этом этапе мы определяем, какие товары потенциально интересны для заказа и отбираем те, с которыми предстоит работа, исходя из данных, уже находящихся или предполагаемых к хранению в базе данных, соответствующей SCHEMA.md.

*   **Исходные данные:** Данные о товарах, которые **предполагается хранить** в таблицах `product` и `queue`. Приоритезация основана на анализе полей `status_id` и `priority_id` из таблицы `queue`, связанных с информацией о товаре (`keyword`, `wekan_task_id`, `wekan_priority`) из таблицы `product`. Текущие методы приоритизации **будут преобразованы** в значения, соответствующие полям `status_id` и `priority_id` в таблице `queue`.

*   **Что фиксируем в DATA.md:**
    *   Для каждого рассмотренного товара в таблице `product`:
        *   `id`: Уникальный идентификатор товара.
        *   `keyword`: Ключевые слова или название для идентификации товара.
        *   `wekan_task_id`: ID задачи из Wekan (если применимо).
        *   `wekan_priority`: Уровень приоритета из Wekan (если применимо).
    *   Для каждого соответствующего элемента в таблице `queue`:
        *   `status_id`: ID статуса элемента в очереди (ссылка на `status`).
        *   `priority_id`: ID внутреннего приоритета для обработки (ссылка на `priority`).
        *   `note`: Любые примечания или контекст.
    *   Критерии отбора для перехода на следующий этап (например, определенные значения `status_id` и `priority_id`).
    *   Результат отбора: список `product.id`, выбранных для дальнейшей работы.

## 2. Поиск/Эффективность (Анализ Экономической Выгоды)

На этом этапе мы детально анализируем выбранные товары с точки зрения экономической выгоды и других факторов, используя данные из различных источников, которые в конечном итоге также будут отражены в БД.
*   **Исходные данные:** Информация о текущих ценах, скидках, купонах, кешбэке, стоимости доставки из различных источников (например, веб-сервисы, прайс-листы, данные конкурентов), которые должны быть сопоставлены с соответствующими полями в SCHEMA.md для последующей загрузки в БД. Эти данные будут в первую очередь сопоставляться с таблицами `offer` и `competitor_price`.
*   **Что фиксируем в DATA.md:**
    *   Для каждого выбранного товара:
        *   Финальная цена товара с учетом всех скидок и бонусов (`final_price`).
        *   Расчет потенциального кешбэка (`potential_cashback`).
        *   Сравнение с ценами конкурентов (если применимо) (`competitor_analysis_notes`).
        *   Причина выбора конкретного продавца/предложения (`offer_selection_reason`).

## 3. Идентификация и Настройка Пользователя

На этом этапе создается или идентифицируется тестовый пользователь, включая его учетные данные и адреса. Эти данные необходимы для дальнейшего формирования корзины и оформления заказа.

*   **Исходные данные:** Информация, необходимая для создания тестового пользователя (например, имя пользователя, email) и его адресов (улица, город, страна и т.д.).
*   **Что фиксируем в DATA.md:**
    *   Данные для таблицы `user_account`:
        *   `id` (placeholder, например, `user_test_001`)
        *   `username`
        *   `password` (для тестовых целей, может быть упрощенным)
        *   `email`
        *   `created_at` (Timestamp)
        *   `default_shipping_address_id` (FK, будет связано с `address.id`)
    *   Данные для таблицы `address` (может быть несколько адресов для пользователя):
        *   `id` (placeholder, например, `addr_001`)
        *   `street`
        *   `city`
        *   `state_province`
        *   `postal_code`
        *   `country`
        *   `building_apt`
        *   `details` (дополнительная информация, если есть)

## 4. Корзина (Формирование Заказа)

На этом этапе выбранные товары добавляются в корзину и формируется сам заказ, с фиксацией данных, которые будут загружены в таблицы `basket` и `basket_item` в БД.

*   **Исходные данные:** Результаты этапа 2, информация о доступности товара, минимальном количестве для заказа (если есть) - данные, предназначенные для последующей загрузки в таблицы `product`, `basket_item` и, возможно, `product_inventory` в БД. Также учитывается стратегия формирования корзины (`basket_strategy`) для оптимизации под купоны или сравнения.
*   **Что фиксируем в DATA.md:**
    *   Идентификатор корзины (для группировки товаров) (`basket_id`).
    *   `user_account_id` (FK, из Этапа 3).
    *   Стратегия формирования корзины (`basket_strategy`), соответствующая полю `strategy` в таблице `basket`.
    *   Для каждого товара в корзине (в `basket_item`):
        *   Количество (`qty`).
        *   Цена на момент добавления (`price_at_add`).
        *   Промежуточная стоимость (`subtotal`).
        *   Ссылка на исходный элемент очереди (`queue_id`).
    *   Общая стоимость корзины (`basket_total_amount`), соответствующая полю `total_amount` в таблице `basket`.
    *   Примененные купоны или промокоды (`applied_coupons`), предназначенные для фиксации (возможно, в отдельной таблице или в поле `details` заказа/платежа).
    *   Выбранный способ доставки и его стоимость (предварительно) (`preliminary_shipping_method`, `preliminary_shipping_cost`), предназначенные для фиксации в таблице `shipment`.
    *   Промежуточный статус корзины/заказа (например, "в корзине", "оформляется"), соответствующий статусам в SCHEMA.md (связанным с таблицами `basket` или `order`).
    *   Итоговая стоимость с учетом доставки и скидок (предварительно) (`preliminary_final_amount`).

## 5. Оплата/Кошелек

На этом этапе выбирается метод оплаты, вносится и фиксируется необходимая сумма, с целью подготовки данных для таблиц `payment`, `pay_method` и `wallet` в БД.

*   **Исходные данные:** Общая стоимость заказа, доступные методы оплаты, информация о кошельках - данные, которые будут сопоставлены со `SCHEMA.md` и загружены в БД.
*   **Что фиксируем в DATA.md:**
    *   Идентификатор платежа (для группировки) (`payment_id`).
    *   Идентификатор заказа, к которому относится платеж (`order_id` - будет назначен позже, на этапе 6).
    *   Выбранный метод оплаты (`pay_method_name`), соответствующий полю `name` в таблице `pay_method`.
    *   Использованный кошелек или платежный аккаунт (если применимо) (`wallet_name`), соответствующий полю `name` в таблице `wallet`.
    *   Сумма платежа (`payment_amount`), соответствующая полю `amount` в таблице `payment`.
    *   Статус платежа (`payment_status`), соответствующий статусам в `SCHEMA.md` (связанным с таблицей `payment` через `status_id`).
    *   Расчетный или полученный кешбэк (`cashback_received`), соответствующий полю `cashback_received` в таблице `payment`.
    *   Детали транзакции (если доступны и не содержат чувствительных данных) (`transaction_details`), предназначенные для фиксации в БД (возможно, в поле `details` таблицы `payment`).
    *   Дата и время платежа (`paid_at`), соответствующее полю `paid_at` в таблице `payment`.

## 6. Оформление Заказа и Доставка

На этом этапе используются данные пользователя для оформления заказа и его окончательной регистрации в системе, с целью заполнения таблиц `order`, `order_item` (финализация), `shipment` и уточнения связи `payment.order_id` в БД.

*   **Исходные данные:** Данные пользователя (из Этапа 3), финальная информация о корзине (из Этапа 4), оплате (из Этапа 5) и доставке.
*   **Что фиксируем в DATA.md:**
    *   Идентификатор пользователя (`user_account_id`, из Этапа 3).
    *   Идентификатор финального заказа (`order_id`), соответствующий первичному ключу таблицы `order`.
    *   Дата и время оформления заказа (`order_date`), соответствующее полю `order_date` в таблице `order`.
    *   Финальный статус заказа (`order_status`), соответствующий статусам в `SCHEMA.md` (связанным с таблицей `order` через `status_id`).
    *   Общая итоговая сумма заказа (`order_total_amount`), соответствующая полю `total_amount` в таблице `order`.
    *   Идентификатор выбранного адреса доставки (`shipping_address_id` из Этапа 3), соответствующий внешнему ключу в таблице `order` и `shipment`.
    *   Идентификатор выбранного биллингового адреса (`billing_address_id` из Этапа 3, если отличается от адреса доставки).
    *   Идентификатор платежа (`payment_id` из Этапа 5), который будет связан с этим `order_id`.
    *   Информация о доставке: идентификатор отгрузки (`shipment_id`), трекинг-номер (`tracking_number`), стоимость доставки (`shipping_cost`), предполагаемые/фактические даты отгрузки/доставки (`shipped_at`, `delivered_at`).
    *   Уточненные данные по элементам заказа (`order_item`), включая финальные цены, скидки, стоимость товаров (`sale_price`, `discount_amount`, `cost_of_goods_sold`), связывая их с `order_id`.

Следуя этим этапам, мы сможем собрать полный набор данных для тестового заказа в DATA.md, который затем будет использован для тщательной валидации и корректировки SCHEMA.md и, в конечном итоге, для упорядоченного заполнения базы данных SQLite.
